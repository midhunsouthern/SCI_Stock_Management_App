<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SCI — Receive (Batches)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 1100px; margin: auto; }
    h1 { margin: 0 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    input, textarea, select, button { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    button { cursor: pointer; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start; }
    .grow { flex:1 1 240px; }
    .muted { color:#666; font-size:14px; }
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 8px; text-align:left; }
    th { background:#fafafa; }
    .right { text-align:right; }
    .warn { color:#c60; font-weight:600; }
    /* Nav */
    nav { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    .tab { padding:8px 12px; border:1px solid #e5e5e5; border-radius:10px; text-decoration:none; color:#222; }
    .tab:hover { background:#f7f7f7; }
    .tab.active { background:#111; color:#fff; border-color:#111; }
    .spacer { flex:1; }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav>
    <a class="tab" href="/index.html">Item Master</a>
    <a class="tab active" href="/batches.html">Receive (Batches)</a>
    <a class="tab" href="/consumption.html" title="Coming soon">Consumption</a>
    <a class="tab" href="/suppliers.html" title="Coming soon">Suppliers</a>
    <span class="spacer"></span>
  </nav>

  <h1>SCI — Receive Batch</h1>
  <p class="muted">Create a batch and auto-create box-wise <b>IN</b> lines in Movements. Transport cost is allocated per kg.</p>

  <div class="card">
    <h3>Batch Details</h3>
    <div class="row">
      <select id="itemSelect" class="grow"></select>
      <input id="receivedDate" type="date" class="grow" />
      <input id="basicRate" type="number" step="0.01" placeholder="Basic rate / UOM (₹)" class="grow" />
      <input id="transportTotal" type="number" step="0.01" placeholder="Total transport (₹)" class="grow" />
      <input id="totalQty" type="number" step="0.01" placeholder="Total quantity (e.g., 500)" class="grow" />
    </div>
    <div class="row" style="margin-top:8px;">
      <textarea id="supplier" class="grow" rows="2" placeholder="Supplier details"></textarea>
    </div>
    <div class="row" style="margin-top:8px;">
      <textarea id="boxWeights" class="grow" rows="3" placeholder="Box weights (comma-separated), e.g. 100,100,100,100,100"></textarea>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="previewBtn">Preview Costs</button>
      <button id="saveBatchBtn">Save Batch & Create IN Lines</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h3>Preview / This Session</h3>
    <table>
      <thead><tr><th>Serial</th><th>Item</th><th class="right">Qty</th><th class="right">Unit Basic</th><th class="right">Unit Transp</th><th class="right">Unit Cost</th><th class="right">Total</th></tr></thead>
      <tbody id="movBody"><tr><td colspan="7" class="muted">No entries yet.</td></tr></tbody>
      <tfoot>
        <tr><th colspan="2" class="right">Totals</th><th id="tQty" class="right">0</th><th></th><th></th><th></th><th id="tVal" class="right">0.00</th></tr>
      </tfoot>
    </table>
    <p id="note" class="muted"></p>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.43.4/dist/umd/supabase.js"></script>
  <script>
    // Supabase project
    const SUPABASE_URL = "https://yifgximvlqblnvxsmizx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpZmd4aW12bHFibG52eHNtaXp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDIwNjMsImV4cCI6MjA3MDM3ODA2M30.Q6Bb7GCsZLSz-pjzHi0T-FTRx1uWkb1zu68AGnCiUhw";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = id => document.getElementById(id);
    function pad(n, w=3){ return String(n).padStart(w,'0'); }

    let currentPreview = []; // cache for Save

    async function loadItems() {
      const sel = $('itemSelect');
      sel.innerHTML = '<option>Loading items…</option>';
      const { data, error } = await client.from('items').select('id,item_id,item_name,uom').order('item_id');
      if (error) { sel.innerHTML = '<option>Error loading items</option>'; return; }
      sel.innerHTML = '<option value="">Select item…</option>' + data.map(r =>
        `<option value="${r.id}" data-code="${r.item_id}" data-name="${r.item_name}" data-uom="${r.uom||''}">
          ${r.item_id} — ${r.item_name}
        </option>`).join('');
    }

    function parseWeights() {
      return $('boxWeights').value
        .split(',')
        .map(s => Number(s.trim()))
        .filter(n => !isNaN(n) && n > 0);
    }

    function buildPreview() {
      const itemOpt = $('itemSelect').selectedOptions[0];
      if (!itemOpt || !itemOpt.value) return { ok:false, msg:'Select an item.' };

      const itemId = itemOpt.value;
      const itemCode = itemOpt.dataset.code;
      const itemName = itemOpt.dataset.name;

      const date = $('receivedDate').value;
      if (!date) return { ok:false, msg:'Enter received date.' };

      const basicRate = Number($('basicRate').value || 0);
      const transportTotal = Number($('transportTotal').value || 0);
      const totalQty = Number($('totalQty').value || 0);
      const weights = parseWeights();

      if (totalQty <= 0 || weights.length === 0) return { ok:false, msg:'Enter total qty and box weights.' };

      const sumWeights = weights.reduce((a,b)=>a+b,0);
      if (Math.abs(sumWeights - totalQty) > 0.0001) {
        return { ok:false, msg:`Sum of box weights (${sumWeights}) must equal total quantity (${totalQty}).` };
      }

      const transportPerKg = transportTotal && totalQty ? (transportTotal / totalQty) : 0;
      const unitCost = basicRate + transportPerKg;
      const serialBase = `${itemCode}-${date.replaceAll('-','')}`;

      const rows = weights.map((w,i) => ({
        item_id: itemId,
        item_code: itemCode,
        item_name: itemName,
        movement_type: 'IN',
        movement_date: new Date(date).toISOString(),
        quantity: w,
        unit_basic_rate: basicRate || 0,
        unit_transport_rate: transportPerKg || 0,
        unit_cost: unitCost,
        total_value: unitCost * w,
        serial_no: `${serialBase}-${pad(i+1)}`,
        box_no: i+1
      }));

      return { ok:true, rows, totals: { qty: sumWeights, value: rows.reduce((a,r)=>a+(r.total_value||0),0) } };
    }

    function renderPreview(preview){
      const tbody = $('movBody');
      if (!preview.ok) {
        tbody.innerHTML = `<tr><td colspan="7" class="warn">${preview.msg}</td></tr>`;
        $('tQty').textContent = '0';
        $('tVal').textContent = '0.00';
        $('note').textContent = '';
        currentPreview = [];
        return;
      }
      const rows = preview.rows;
      currentPreview = rows;
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.serial_no}</td>
          <td>${r.item_code} — ${r.item_name}</td>
          <td class="right">${r.quantity}</td>
          <td class="right">${r.unit_basic_rate.toFixed(2)}</td>
          <td class="right">${r.unit_transport_rate.toFixed(2)}</td>
          <td class="right">${r.unit_cost.toFixed(2)}</td>
          <td class="right">${r.total_value.toFixed(2)}</td>
        </tr>
      `).join('');
      $('tQty').textContent = preview.totals.qty;
      $('tVal').textContent = preview.totals.value.toFixed(2);
      $('note').textContent = 'Transport cost allocated uniformly per kg across all boxes.';
    }

    async function saveBatchAndLines() {
      const msg = $('msg'); msg.textContent = 'Saving…';

      const preview = buildPreview();
      if (!preview.ok) { renderPreview(preview); msg.textContent = preview.msg; return; }

      const itemId = $('itemSelect').value;
      const supplier = $('supplier').value.trim() || null;
      const date = $('receivedDate').value;
      const basicRate = Number($('basicRate').value || 0);
      const transportTotal = Number($('transportTotal').value || 0);
      const totalQty = Number($('totalQty').value || 0);

      // 1) Create batch
      const { data: batchRows, error: batchErr } = await client.from('batches').insert([{
        item_id: itemId,
        item_received_date: date,
        supplier_details: supplier,
        basic_rate: basicRate || null,
        transport_cost_total: transportTotal || null,
        total_quantity: totalQty
      }]).select('id');
      if (batchErr) { msg.textContent = 'Batch error: ' + batchErr.message; return; }
      const batchId = batchRows[0].id;

      // 2) Create IN lines in movements
      const rows = currentPreview.map(r => ({
        item_id: itemId,
        batch_id: batchId,
        movement_type: 'IN',
        movement_date: r.movement_date,
        quantity: r.quantity,
        unit_basic_rate: r.unit_basic_rate,
        unit_transport_rate: r.unit_transport_rate,
        unit_cost: r.unit_cost,
        total_value: r.total_value,
        serial_no: r.serial_no,
        box_no: r.box_no,
        comments: 'Box received'
      }));

      const { error: movErr } = await client.from('movements').insert(rows);
      if (movErr) { msg.textContent = 'Movements error: ' + movErr.message; return; }

      msg.textContent = `Saved. Created ${rows.length} IN lines.`;
    }

    $('previewBtn').addEventListener('click', () => renderPreview(buildPreview()));
    $('saveBatchBtn').addEventListener('click', saveBatchAndLines);
    loadItems();
  </script>
</body>
</html>
